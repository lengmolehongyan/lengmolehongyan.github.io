---
layout: post
title: "约束剖析（Anatomy of a Constraint）"
date: 2016-01-02 12:09:52 +0800
comments: true
categories: 
keywords: iOS，约束剖析，自动布局
description: iOS，约束剖析，自动布局
---

视图层次结构上的布局是由一些列的公式（线性方程）来定义的，每个约束都有一个单一的表达式，你的目标就是要让这一系列的表达式有且仅有一个结果。

示例公式如下：

<!--more-->

![view_formula](https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/AutolayoutPG/Art/view_formula_2x.png)

这个约束声明了红色视图（view）的左边（leading）距离蓝色视图（view）的右边（trailing）始终保持 8 个点，这个公式有如下几项：

* **item 1（第一项）**：表达式中的第一项，在这个例子中，就是红色视图（view）。这一项必须是一个视图（view）或者是一个布局参考线（layout guide）。
* **Attribute 1（属性 1）**：要约束表达式中第一项的属性，在此例中，就是红色视图（view）的左边（leading）。
* **Relationship（关系）**：表达式左右两边之间的关系，有三种关系，等于，大于等于，小于等于，在此例中，左右两边是相等的关系。
* **Multiplier（乘数）**：此浮点数值将用于和属性 2 的值相乘，在此例中，这个值是 1.0。
* **Item 2（第二项）**：表达式中的第二项，在此例中就是蓝色视图（view），不像第一项，这一项可以是空的。
* **Attribute 2（属性 2）**：要约束表达式中第二项的属性，在此例中，就是蓝色视图（view）的右边（trailing）。如果第二项是空，这里一定不是一个属性。
* **Constant（常量）**：一个表示偏移量的浮点数常量，在此例中，值是 8.0。这个值是用来添加到属性 2 上的。

<p></p>
界面上的大多数约束是由两项之间的关系表示的，这些项可以是视图，也可以是布局参考线。约束也可以表示同一视图两个不同属性之间的关系，比如，设置视图的宽高比例，也可以给视图的高或宽设置为一个常量值，当设置为常量值时，第二项为空，第二项的属性设置为 Not An Attribute，乘数为 0.0。

## 自动布局属性

在自动布局中，属性的功能就是被约束的，通常包括四个边界（前后上下），还有高度、宽度以及垂直和水平中心。文本控件还有一个或多个基线（baseline）属性。

![attributes](https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/AutolayoutPG/Art/attributes_2x.png)

有关完整的布局属性列表，参阅 [NSLayoutAttribute 枚举](https://developer.apple.com/library/ios/documentation/AppKit/Reference/NSLayoutConstraint_Class/index.html#//apple_ref/c/tdef/NSLayoutAttribute) 。

> 注：
> 虽然 OSX 和 iOS 都是使用 NSLayoutAttribute 枚举，但它们定义的值集稍有不同，查阅完整布局属性列表时，请确保查看的是正确平台的文档。


## 示例方程

通过方程中大量的参数和属性可以创建多种不同类型的约束，你可以定义两个视图之间的间距、视图边缘的对齐方式、两个视图的相对大小，甚至定义视图的纵横比。然而，并非所有属性都是兼容的。

有两种基本类型的属性，大小属性（例如，高度和宽度）和位置属性（例如，左边和顶部）。大小属性用于指定一个视图有多大，并不指定视图的位置。位置属性用于指定视图相对其他视图的位置，同样不涉及视图的大小。

带着这些差异，再看看下面这些规则：

* 大小属性的约束不能添加到位置属性上
* 大小属性只能赋值常量
* 对于位置属性，不能将垂直属性的约束添加到水平属性上
* 对于位置属性，不能将 Leading 和 Trailing 属性的约束添加到 Left 和 Right 属性上

<p></p>
例如，没有额外的属性仅设置一个视图的顶部为一个常量值 20.0 是没有意义的，必须总是定义某一视图相对于其他视图的位置属性，比如，设置距离其父视图的顶部为 20.0 个点。然而，设置某一视图的高度是 20.0 是有效的。更多信息，参阅 [自动布局属性值解释]()。

3-1 列出了不同常见约束的表达式。

> 注：
> 本章节所有示例方程都是使用的伪代码，想看实际代码创建约束，参阅 [自动布局手册]() 和 [代码创建约束]()。

```objc
// 3-1 常见约束示例表达式
// 设置高度常量值
View.height = 0.0 * NotAnAttribute + 40.0
 
// 设置两个按钮之间的固定间距
Button_2.leading = 1.0 * Button_1.trailing + 8.0
 
// 设置两个按钮的前部边缘对齐
Button_1.leading = 1.0 * Button_2.leading + 0.0
 
// 设置两个按钮的宽度相同
Button_1.width = 1.0 * Button_2.width + 0.0
 
// 设置视图在其父视图的中心
View.centerX = 1.0 * Superview.centerX + 0.0
View.centerY = 1.0 * Superview.centerY + 0.0
 
// 设置视图的宽高比为一个常量值
View.height = 2.0 * View.width + 0.0
```

## 相等，不是赋值

注意，示例中方程的等号表示的是相等，而不是赋值。

当自动布局求解这些方程时，并不是将等式右边的值赋值给等式左边。相反，它同时计算属性 1 和属性 2 的值使它们之间的关系成立，这就意味着可以自由调整表达式中的项。比如，3-2 中的方程就和 3-1 的结果是相同的。

```objc
// 3-2 反向方程
// 设置两个按钮之间的固定间距
Button_1.trailing = 1.0 * Button_2.leading - 8.0
 
// 设置两个按钮的前部边缘对齐
Button_2.leading = 1.0 * Button_1.leading + 0.0
 
// 设置两个按钮宽度相同
Button_2.width = 1.0 * Button.width + 0.0
 
// 设置视图在其父视图的中心
Superview.centerX = 1.0 * View.centerX + 0.0
Superview.centerY = 1.0 * View.centerY + 0.0
 
// 设置视图的宽高比为一个常量值
View.width = 0.5 * View.height + 0.0
```

> 注：
> 当重新调整方程中的项时，请确保调整了乘数和常量。比如，常量值 8.0 要变成 -8.0，乘数 2.0 要变成 0.5，常量值 0.0 和 乘数 1.0 保持不变。

你会发现，自动布局经常提供多种方式来解决同样的问题。理想情况下，你应该选择的是最能清晰表达意图的方案。然而，不同的开发者无疑会不同意哪个方案是最好的。这里，相比正确的方案，一贯选择好的方案。如果你选择一种方案，并坚持使用，从长远来看，你将遇到很少问题。比如，本指南使用以下规则：

1. 整数乘法优先于小数乘法。
2. 正数优先于负数。
3. 不管在哪，视图应该以从前到后，从上到下的布局顺序。

## 创建没有歧义的、不冲突的布局

使用自动布局的目标就是，创建一系列方程让这每一个方程有且仅有一个可能的结果。有歧义的约束有不止一个结果，冲突的约束不会有有效的结果。

一般情况下，必须为每一个视图都指定大小和位置的约束。但是，假设父视图的尺寸已经设置了（比如，在 iOS 中控制器的根视图），


